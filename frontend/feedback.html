<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Park Ranger | Feedback Data</title>
    <style>
        body {
            background-color: #F4F1E1; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #6C4A3D; 
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h2 { margin: 0; font-weight: normal; }
        .btn-logout {
            background-color: #D9534F;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-menu {
            background-color: #A67B5B;
            padding: 10px 30px;
            display: flex;
            gap: 20px;
        }
        .tab-menu a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        .tab-menu a.active {
            background-color: white;
            color: #6C4A3D;
            font-weight: bold;
        }
        .tab-menu a:hover:not(.active) { background-color: #8C6246; }
        
        .container { padding: 30px; }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .page-header h3 { margin: 0 0 5px 0; font-size: 20px; }
        .page-header p { margin: 0; color: #666; font-size: 14px; }
        .btn-export {
            background-color: #FFF;
            border: 1px solid #CCC;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
        }
        .btn-export:hover { background-color: #EEE; }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #CCC;
            border-radius: 4px;
            flex: 1;
        }
        .entry-count { font-size: 12px; color: #777; margin-bottom: 15px; }

        /* Table */
        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #EEE; font-size: 14px; }
        th { color: #555; font-weight: bold; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-pos { background-color: #E8F5E9; color: #2E7D32; }
        .badge-neu { background-color: #FFF3E0; color: #E65100; }
        .badge-neg { background-color: #FFEBEE; color: #C62828; }
    </style>
</head>
<body>

    <div class="navbar">
        <h2>Park Ranger Sentiment Analysis Dashboard</h2>
        <button class="btn-logout" id="logoutBtn">Logout</button>
    </div>
    
    <div class="tab-menu">
        <a href="dashboard.html">Overview</a>
        <a href="locations.html">Locations</a>
        <a href="products.html">Products</a>
        <a href="feedback.html" class="active">Feedback Data</a>
    </div>

    <div class="container">
        <div class="page-header">
            <div>
                <h3>Feedback Data</h3>
                <p>All customer feedback with sentiment analysis</p>
            </div>
            <button class="btn-export" id="exportBtn">Export CSV</button>
        </div>

        <div class="filters">
            <input type="text" id="searchFeedback" placeholder="Search feedback...">
            <select id="filterSentiment">
                <option value="All">All Sentiments</option>
                <option value="Positive">Positive</option>
                <option value="Neutral">Neutral</option>
                <option value="Negative">Negative</option>
            </select>
            <select id="filterLocation">
                <option value="All">All Locations</option>
            </select>
            <select id="filterProduct">
                <option value="All">All Products</option>
            </select>
        </div>

        <div class="entry-count" id="entryCount">Showing 0 of 0 entries</div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Location</th>
                        <th>Product</th>
                        <th>Feedback</th>
                        <th>Sentiment</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        if (!localStorage.getItem('ranger_token')) window.location.href = 'index.html';
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('ranger_token');
            window.location.href = 'index.html';
        });

        // Global variables to hold data
        let allFeedback = [];
        let filteredFeedback = [];
        let locMap = {};
        let prodMap = {};
        const sourceMap = { 1: 'Facebook', 2: 'Google Reviews', 3: 'Instagram', 4: 'Verbal Feedback' }; // Fallback map based on dummy data

        async function initPage() {
            try {
                // Fetch data
                const [feedRes, locRes, prodRes] = await Promise.all([
                    fetch('http://127.0.0.1:5000/feedback'),
                    fetch('http://127.0.0.1:5000/locations'),
                    fetch('http://127.0.0.1:5000/products')
                ]);

                allFeedback = await feedRes.json();
                const locations = await locRes.json();
                const products = await prodRes.json();

                // Sort feedback by newest first (descending ID)
                allFeedback.sort((a, b) => b.feedback_id - a.feedback_id);

                // Build lookup maps and populate dropdowns
                const locSelect = document.getElementById('filterLocation');
                locations.forEach(l => {
                    locMap[l.location_id] = l.location_name;
                    locSelect.innerHTML += `<option value="${l.location_id}">${l.location_name}</option>`;
                });

                const prodSelect = document.getElementById('filterProduct');
                products.forEach(p => {
                    prodMap[p.product_id] = p.product_name;
                    prodSelect.innerHTML += `<option value="${p.product_id}">${p.product_name}</option>`;
                });

                // Initial render
                applyFilters();

            } catch (err) {
                console.error("Error loading data:", err);
            }
        }

        function applyFilters() {
            const searchText = document.getElementById('searchFeedback').value.toLowerCase();
            const sentiment = document.getElementById('filterSentiment').value;
            const locationId = document.getElementById('filterLocation').value;
            const productId = document.getElementById('filterProduct').value;

            filteredFeedback = allFeedback.filter(f => {
                const matchSearch = f.feedback_text.toLowerCase().includes(searchText);
                const matchSentiment = sentiment === 'All' || f.sentiment_label === sentiment;
                const matchLocation = locationId === 'All' || f.location_id.toString() === locationId;
                const matchProduct = productId === 'All' || f.product_id.toString() === productId;
                return matchSearch && matchSentiment && matchLocation && matchProduct;
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredFeedback.forEach(f => {
                let badgeClass = 'badge-neu';
                if (f.sentiment_label === 'Positive') badgeClass = 'badge-pos';
                if (f.sentiment_label === 'Negative') badgeClass = 'badge-neg';

                // Format date cleanly
                const dateObj = new Date(f.created_at);
                const dateString = isNaN(dateObj) ? 'N/A' : dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                tbody.innerHTML += `
                    <tr>
                        <td>${dateString}</td>
                        <td>${locMap[f.location_id] || 'Unknown'}</td>
                        <td>${prodMap[f.product_id] || 'Unknown'}</td>
                        <td style="max-width: 400px; line-height: 1.4;">${f.feedback_text}</td>
                        <td><span class="badge ${badgeClass}">${f.sentiment_label}</span></td>
                        <td>${sourceMap[f.source_id] || 'Other'}</td>
                    </tr>
                `;
            });

            // Update entry count text
            document.getElementById('entryCount').innerText = `Showing ${filteredFeedback.length} of ${allFeedback.length} entries`;
        }

        // CSV Export Functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (filteredFeedback.length === 0) return alert("No data to export!");

            // Headers
            let csvContent = "Date,Location,Product,Feedback,Sentiment,Source\n";

            // Rows
            filteredFeedback.forEach(f => {
                const dateStr = new Date(f.created_at).toLocaleDateString('en-US');
                const locStr = locMap[f.location_id] || 'Unknown';
                const prodStr = prodMap[f.product_id] || 'Unknown';
                const sourceStr = sourceMap[f.source_id] || 'Other';
                // Escape quotes in feedback text so it doesn't break CSV formatting
                const safeFeedback = `"${f.feedback_text.replace(/"/g, '""')}"`; 
                
                csvContent += `${dateStr},${locStr},${prodStr},${safeFeedback},${f.sentiment_label},${sourceStr}\n`;
            });

            // Trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "park_ranger_feedback.csv";
            link.click();
        });

        // Event Listeners for Filters
        document.getElementById('searchFeedback').addEventListener('input', applyFilters);
        document.getElementById('filterSentiment').addEventListener('change', applyFilters);
        document.getElementById('filterLocation').addEventListener('change', applyFilters);
        document.getElementById('filterProduct').addEventListener('change', applyFilters);

        // Start
        initPage();
    </script>
</body>
</html>