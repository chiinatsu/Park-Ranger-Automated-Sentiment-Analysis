<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Park Ranger | Products</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #F4F1E1; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #6C4A3D; 
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h2 { margin: 0; font-weight: normal; }
        .btn-logout {
            background-color: #D9534F;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-menu {
            background-color: #A67B5B;
            padding: 10px 30px;
            display: flex;
            gap: 20px;
        }
        .tab-menu a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        .tab-menu a.active {
            background-color: white;
            color: #6C4A3D;
            font-weight: bold;
        }
        .tab-menu a:hover:not(.active) { background-color: #8C6246; }
        
        .container { padding: 30px; }
        .summary-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 5px solid gray;
        }
        .card.best { border-left-color: #4CAF50; } 
        .card.strong { border-left-color: #A67B5B; } 
        .card.needs { border-left-color: #D9534F; } 
        
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #555; }
        .card .product-name { font-size: 24px; font-weight: bold; margin: 0 0 5px 0; }
        .card .score { font-size: 12px; color: #777; }
        
        .charts-row { display: flex; gap: 20px; }
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .canvas-wrapper {
            position: relative;
            height: 300px; 
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="navbar">
        <h2>Park Ranger Sentiment Analysis Dashboard</h2>
        <button class="btn-logout" id="logoutBtn">Logout</button>
    </div>
    
    <div class="tab-menu">
        <a href="dashboard.html">Overview</a>
        <a href="locations.html">Locations</a>
        <a href="products.html" class="active">Products</a>
        <a href="feedback.html">Feedback Data</a>
    </div>

    <div class="container">
        <div class="summary-cards" id="productCards">
            </div>

        <div class="charts-row">
            <div class="chart-container">
                <h3>Product Performance Trend</h3>
                <div class="canvas-wrapper">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3>Category Comparison</h3>
                <div class="canvas-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (!localStorage.getItem('ranger_token')) window.location.href = 'index.html';
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('ranger_token');
            window.location.href = 'index.html';
        });

        async function loadProductData() {
            try {
                // Fetch Products and Feedback simultaneously
                const [prodRes, feedRes] = await Promise.all([
                    fetch('http://127.0.0.1:5000/products'),
                    fetch('http://127.0.0.1:5000/feedback')
                ]);

                const products = await prodRes.json();
                const feedback = await feedRes.json();

                // 1. Populate Cards
                const cardsContainer = document.getElementById('productCards');
                const tiers = { 'Best Performer': 'best', 'Strong Contender': 'strong', 'Needs Improvement': 'needs' };

                // Sort products to ensure they appear in the correct tier order
                const orderedProducts = products.sort((a, b) => b.sentiment_rate - a.sentiment_rate);

                orderedProducts.forEach(prod => {
                    const cssClass = tiers[prod.performance_tier] || 'strong';
                    cardsContainer.innerHTML += `
                        <div class="card ${cssClass}">
                            <h3>${prod.performance_tier}</h3>
                            <p class="product-name">${prod.product_name}</p>
                            <p class="score">Performance Rate: ${prod.sentiment_rate}%</p>
                        </div>
                    `;
                });

                // 2. Line Chart (Mocking monthly data to match PDF requirements)
                new Chart(document.getElementById('lineChart'), {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [
                            { label: 'Coffee', data: [82, 84, 85, 86, 87, 87], borderColor: '#4CAF50', fill: false },
                            { label: 'Choco', data: [78, 79, 80, 81, 81, 81], borderColor: '#A67B5B', fill: false },
                            { label: 'Tea', data: [71, 72, 73, 73, 74, 74], borderColor: '#D9534F', fill: false }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 60, max: 100 } } }
                });

                // 3. Category Comparison Bar Chart (Calculated dynamically!)
                const categories = ['taste_score', 'quality_score', 'value_score', 'service_score', 'presentation_score'];
                const labels = ['Taste', 'Quality', 'Value', 'Service', 'Presentation'];
                const colors = ['#4CAF50', '#A67B5B', '#D9534F'];
                const datasets = [];

                products.forEach((prod, index) => {
                    // Filter feedback for this product
                    const prodFeedback = feedback.filter(f => f.product_id === prod.product_id);
                    const avgScores = [];

                    categories.forEach(cat => {
                        // Calculate average out of 5, then multiply by 20 to scale to 100%
                        const validScores = prodFeedback.filter(f => f[cat] !== null);
                        const sum = validScores.reduce((acc, curr) => acc + curr[cat], 0);
                        const avg = validScores.length > 0 ? (sum / validScores.length) * 20 : 0;
                        avgScores.push(avg);
                    });

                    datasets.push({
                        label: prod.product_name,
                        data: avgScores,
                        backgroundColor: colors[index % colors.length]
                    });
                });

                new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: { labels: labels, datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
                });

            } catch (err) {
                console.error("Error loading product data:", err);
            }
        }

        loadProductData();
    </script>
</body>
</html>